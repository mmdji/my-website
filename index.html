<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت مالی شخصی</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Day.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/fa.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        /* For custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        /* Chart.js responsive fix */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
    
    <script>
        // Initialize Day.js with Persian locale
        dayjs.locale('fa');
        dayjs.extend(dayjs_plugin_relativeTime);
        
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Vazirmatn', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="app" class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white dark:bg-gray-800 shadow-lg md:shadow-none p-4 md:p-6 flex flex-row md:flex-col justify-between md:justify-start">
            <div>
                <div class="flex items-center gap-3 mb-8">
                    <div class="bg-indigo-500 p-2 rounded-lg">
                        <i data-lucide="wallet" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">حساب من</h1>
                </div>
                <nav class="flex flex-row md:flex-col gap-2 justify-center">
                    <a href="#dashboard" class="nav-link active flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="layout-dashboard"></i><span>داشبورد</span>
                    </a>
                    <a href="#transactions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="arrow-right-left"></i><span>تراکنش‌ها</span>
                    </a>
                    <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="bar-chart-3"></i><span>گزارش‌ها</span>
                    </a>
                    <a href="#debts" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                       <i data-lucide="hand-coins"></i> <span>بدهی و طلب</span>
                    </a>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                 <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i id="theme-icon" data-lucide="sun"></i>
                </button>
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="User" class="rounded-full">
                    <div class="hidden md:block">
                        <p class="font-semibold">کاربر تست</p>
                        <p class="text-xs text-gray-500">user@example.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- Dashboard Page -->
            <section id="dashboard" class="page">
                <h2 class="text-2xl font-bold mb-6">داشبورد خلاصه</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full">
                            <i data-lucide="arrow-down-left" class="text-green-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">مجموع درآمد</p>
                            <p id="summary-income" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-red-100 dark:bg-red-900 p-3 rounded-full">
                            <i data-lucide="arrow-up-right" class="text-red-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">مجموع هزینه</p>
                            <p id="summary-expense" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full">
                            <i data-lucide="scale" class="text-blue-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">موجودی فعلی</p>
                            <p id="summary-balance" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full">
                            <i data-lucide="alert-triangle" class="text-yellow-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">بدهی‌های پرداخت‌نشده</p>
                            <p id="summary-debt" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">روند ماهانه</h3>
                        <div class="chart-container" style="height:300px">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">هزینه‌ها بر اساس دسته‌بندی</h3>
                        <div class="chart-container" style="height:300px">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">آخرین تراکنش‌ها</h3>
                        <div id="recent-transactions" class="space-y-4">
                            <!-- Recent transactions will be injected here -->
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">یادآوری بدهی و طلب</h3>
                        <div id="debt-reminders" class="space-y-4">
                           <!-- Debt reminders will be injected here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Transactions Page -->
            <section id="transactions" class="page hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">لیست تراکنش‌ها</h2>
                    <button id="add-transaction-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                        <i data-lucide="plus"></i>
                        <span>تراکنش جدید</span>
                    </button>
                </div>
                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="جستجو در توضیحات..." class="flex-grow bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                    <select id="filter-type" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                        <option value="all">همه نوع</option>
                        <option value="income">درآمد</option>
                        <option value="expense">هزینه</option>
                    </select>
                    <select id="filter-category" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                         <option value="all">همه دسته‌بندی‌ها</option>
                    </select>
                    <input type="month" id="filter-month" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                    <button id="apply-filters" class="bg-gray-200 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">اعمال فیلتر</button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="border-b dark:border-gray-700">
                            <tr>
                                <th class="p-4">نوع</th>
                                <th class="p-4">دسته‌بندی</th>
                                <th class="p-4">مبلغ</th>
                                <th class="p-4">تاریخ</th>
                                <th class="p-4 hidden md:table-cell">توضیحات</th>
                                <th class="p-4">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Table rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Reports Page -->
            <section id="reports" class="page hidden">
                 <h2 class="text-2xl font-bold mb-6">گزارش‌گیری و تحلیل</h2>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                     <p class="text-center text-gray-500">بخش گزارش‌گیری در حال ساخت است.</p>
                     <p class="text-center mt-2">در نسخه نهایی، امکان دانلود گزارش‌های روزانه، ماهانه و سالانه در فرمت‌های CSV و PDF وجود خواهد داشت.</p>
                 </div>
            </section>
            
            <!-- Debts Page -->
            <section id="debts" class="page hidden">
                 <h2 class="text-2xl font-bold mb-6">مدیریت بدهی و طلب</h2>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                     <p class="text-center text-gray-500">بخش مدیریت بدهی و طلب در حال ساخت است.</p>
                      <p class="text-center mt-2">در نسخه نهایی، می‌توانید بدهی‌ها و طلب‌ها را با تاریخ سررسید ثبت کرده و وضعیت آن‌ها را مدیریت کنید.</p>
                 </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h3 id="modal-title" class="text-xl font-bold mb-6">افزودن تراکنش جدید</h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="type" class="block mb-2 text-sm font-medium">نوع</label>
                        <select id="type" name="type" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                            <option value="expense">هزینه</option>
                            <option value="income">درآمد</option>
                        </select>
                    </div>
                    <div>
                        <label for="category" class="block mb-2 text-sm font-medium">دسته‌بندی</label>
                        <select id="category" name="category" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                            <!-- Categories will be populated by JS -->
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="amount" class="block mb-2 text-sm font-medium">مبلغ (تومان)</label>
                        <input type="number" id="amount" name="amount" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" placeholder="مثلا: 50000">
                    </div>
                     <div>
                        <label for="date" class="block mb-2 text-sm font-medium">تاریخ</label>
                        <input type="date" id="date" name="date" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block mb-2 text-sm font-medium">توضیحات (اختیاری)</label>
                        <textarea id="description" name="description" rows="3" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" placeholder="مثلا: خرید نان و شیر"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">انصراف</button>
                    <button type="submit" id="save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ذخیره</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- DATA & STATE MANAGEMENT ---
        const state = {
            transactions: [],
            categories: {
                expense: ['خوراک', 'حمل و نقل', 'مسکن', 'تفریح', 'پوشاک', 'سلامتی', 'سایر'],
                income: ['حقوق', 'پروژه', 'هدیه', 'سود سهام', 'سایر']
            },
            currency: 'تومان',
            charts: {}
        };

        // --- SAMPLE DATA ---
        function generateSampleData() {
            const sampleTransactions = [
                { id: 1, type: 'income', category: 'حقوق', amount: 15000000, date: dayjs().subtract(1, 'month').format('YYYY-MM-DD'), description: 'حقوق ماه گذشته' },
                { id: 2, type: 'expense', category: 'مسکن', amount: 4500000, date: dayjs().subtract(1, 'month').add(1, 'day').format('YYYY-MM-DD'), description: 'اجاره خانه' },
                { id: 3, type: 'expense', category: 'خوراک', amount: 250000, date: dayjs().subtract(25, 'day').format('YYYY-MM-DD'), description: 'خرید از فروشگاه' },
                { id: 4, type: 'expense', category: 'حمل و نقل', amount: 120000, date: dayjs().subtract(20, 'day').format('YYYY-MM-DD'), description: 'اسنپ' },
                { id: 5, type: 'expense', category: 'تفریح', amount: 300000, date: dayjs().subtract(15, 'day').format('YYYY-MM-DD'), description: 'سینما و شام' },
                { id: 6, type: 'income', category: 'پروژه', amount: 2000000, date: dayjs().subtract(10, 'day').format('YYYY-MM-DD'), description: 'پروژه طراحی سایت' },
                { id: 7, type: 'expense', category: 'پوشاک', amount: 850000, date: dayjs().subtract(5, 'day').format('YYYY-MM-DD'), description: 'خرید لباس' },
                { id: 8, type: 'expense', category: 'خوراک', amount: 95000, date: dayjs().subtract(2, 'day').format('YYYY-MM-DD'), description: 'ناهار' },
                { id: 9, type: 'debt', from: 'دوست', amount: 500000, dueDate: dayjs().add(10, 'day').format('YYYY-MM-DD'), description: 'قرض از علی', paid: false },
                { id: 10, type: 'credit', to: 'همکار', amount: 200000, dueDate: dayjs().add(5, 'day').format('YYYY-MM-DD'), description: 'قرض به سارا', paid: false },
            ];
            // Simulate loading from a database
            state.transactions = sampleTransactions;
        }


        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('fa-IR').format(amount) + ` ${state.currency}`;
        const getElement = (selector) => document.querySelector(selector);
        const getElements = (selector) => document.querySelectorAll(selector);

        // --- UI & RENDERING FUNCTIONS ---
        function renderAll() {
            renderDashboard();
            renderTransactionsPage();
            populateCategoryFilter();
            lucide.createIcons(); // Re-render icons
        }
        
        function renderDashboard() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const unpaidDebt = state.transactions.filter(t => t.type === 'debt' && !t.paid).reduce((sum, t) => sum + t.amount, 0);
            
            getElement('#summary-income').textContent = formatCurrency(income);
            getElement('#summary-expense').textContent = formatCurrency(expense);
            getElement('#summary-balance').textContent = formatCurrency(income - expense);
            getElement('#summary-debt').textContent = formatCurrency(unpaidDebt);
            
            renderRecentTransactions();
            renderDebtReminders();
            renderCharts(income, expense);
        }

        function renderRecentTransactions() {
            const container = getElement('#recent-transactions');
            container.innerHTML = '';
            const recent = [...state.transactions]
                .sort((a, b) => dayjs(b.date).diff(dayjs(a.date)))
                .slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">تراکنشی یافت نشد.</p>`;
                return;
            }

            recent.forEach(t => {
                const isIncome = t.type === 'income';
                const icon = isIncome ? 'trending-up' : 'trending-down';
                const color = isIncome ? 'green' : 'red';
                const sign = isIncome ? '+' : '-';

                const element = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-${color}-100 dark:bg-${color}-900 p-2 rounded-full">
                                <i data-lucide="${icon}" class="text-${color}-500 w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-semibold">${t.description || t.category}</p>
                                <p class="text-sm text-gray-500">${dayjs(t.date).format('dddd، D MMMM')}</p>
                            </div>
                        </div>
                        <p class="font-bold text-${color}-500">${sign}${formatCurrency(t.amount)}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', element);
            });
        }
        
        function renderDebtReminders() {
            const container = getElement('#debt-reminders');
            container.innerHTML = '';
            const reminders = state.transactions
                .filter(t => (t.type === 'debt' || t.type === 'credit') && !t.paid)
                .sort((a, b) => dayjs(a.dueDate).diff(dayjs(b.dueDate)));
                
            if (reminders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">یادآوری فعالی وجود ندارد.</p>`;
                return;
            }

            reminders.slice(0, 4).forEach(t => {
                const isDebt = t.type === 'debt';
                const title = isDebt ? `بدهی به ${t.from}` : `طلب از ${t.to}`;
                const icon = 'alarm-clock';
                const color = dayjs(t.dueDate).isBefore(dayjs()) ? 'red' : 'yellow';
                
                const element = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="bg-${color}-100 dark:bg-${color}-900 p-2 rounded-full">
                                <i data-lucide="${icon}" class="text-${color}-500 w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-semibold">${title}</p>
                                <p class="text-sm text-${color}-500">سررسید: ${dayjs(t.dueDate).fromNow()}</p>
                            </div>
                        </div>
                        <p class="font-bold">${formatCurrency(t.amount)}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', element);
            });
        }
        
        function renderTransactionsPage(filteredTransactions = state.transactions) {
            const tableBody = getElement('#transactions-table-body');
            tableBody.innerHTML = '';

            if (filteredTransactions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">هیچ تراکنشی یافت نشد.</td></tr>`;
                return;
            }

            const transactionsToRender = filteredTransactions.filter(t => t.type === 'income' || t.type === 'expense');

            transactionsToRender.forEach(t => {
                const isIncome = t.type === 'income';
                const typeText = isIncome ? 'درآمد' : 'هزینه';
                const typeColor = isIncome ? 'text-green-500' : 'text-red-500';
                const amountSign = isIncome ? '+' : '-';
                
                const row = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="p-4 font-semibold ${typeColor}">${typeText}</td>
                        <td class="p-4">${t.category}</td>
                        <td class="p-4 font-mono">${amountSign}${formatCurrency(t.amount)}</td>
                        <td class="p-4">${dayjs(t.date).format('YYYY/MM/DD')}</td>
                        <td class="p-4 hidden md:table-cell max-w-xs truncate">${t.description || '-'}</td>
                        <td class="p-4">
                            <div class="flex gap-2">
                                <button class="edit-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${t.id}">
                                    <i data-lucide="pencil" class="w-4 h-4 text-blue-500"></i>
                                </button>
                                <button class="delete-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${t.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Re-add event listeners for new buttons
            addTableButtonListeners();
        }
        
        function renderCharts(income, expense) {
            // Expense Category Pie Chart
            const expenseCtx = getElement('#expenseCategoryChart').getContext('2d');
            const expenseData = state.transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            if (state.charts.expenseChart) state.charts.expenseChart.destroy();
            state.charts.expenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseData),
                    datasets: [{
                        data: Object.values(expenseData),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#6366f1', '#a855f7'],
                        borderColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151' } } }
                }
            });

            // Monthly Trend Line Chart
            const monthlyCtx = getElement('#monthlyTrendChart').getContext('2d');
            const monthlyData = state.transactions.reduce((acc, t) => {
                const month = dayjs(t.date).format('YYYY-MM');
                if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                acc[month][t.type] += t.amount;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort();
            
            if (state.charts.monthlyChart) state.charts.monthlyChart.destroy();
            state.charts.monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => dayjs(m).format('MMMM')),
                    datasets: [
                        {
                            label: 'درآمد',
                            data: sortedMonths.map(m => monthlyData[m].income),
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'هزینه',
                            data: sortedMonths.map(m => monthlyData[m].expense),
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' } },
                        x: { ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' } }
                    },
                     plugins: { legend: { labels: { color: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151' } } }
                }
            });
        }

        // --- MODAL & FORM HANDLING ---
        const modal = getElement('#transaction-modal');
        const form = getElement('#transaction-form');

        function openModal(transaction = null) {
            form.reset();
            getElement('#transaction-id').value = '';
            
            if (transaction) {
                getElement('#modal-title').textContent = 'ویرایش تراکنش';
                getElement('#transaction-id').value = transaction.id;
                getElement('#type').value = transaction.type;
                updateCategoryOptions(transaction.type);
                getElement('#category').value = transaction.category;
                getElement('#amount').value = transaction.amount;
                getElement('#date').value = transaction.date;
                getElement('#description').value = transaction.description;
            } else {
                getElement('#modal-title').textContent = 'افزودن تراکنش جدید';
                getElement('#date').value = dayjs().format('YYYY-MM-DD');
                updateCategoryOptions('expense');
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = getElement('#transaction-id').value;
            const formData = new FormData(form);
            const transactionData = {
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date'),
                description: formData.get('description'),
            };

            if (id) { // Editing existing
                const index = state.transactions.findIndex(t => t.id == id);
                state.transactions[index] = { ...state.transactions[index], ...transactionData };
            } else { // Creating new
                transactionData.id = Date.now();
                state.transactions.push(transactionData);
            }

            closeModal();
            renderAll();
        }
        
        function updateCategoryOptions(type) {
            const categorySelect = getElement('#category');
            categorySelect.innerHTML = '';
            state.categories[type].forEach(cat => {
                const option = `<option value="${cat}">${cat}</option>`;
                categorySelect.insertAdjacentHTML('beforeend', option);
            });
        }
        
        function populateCategoryFilter() {
             const categoryFilter = getElement('#filter-category');
             const existingOptions = new Set(Array.from(categoryFilter.options).map(o => o.value));
             if (existingOptions.has('all')) {
                categoryFilter.innerHTML = '<option value="all">همه دسته‌بندی‌ها</option>';
             }
             const allCategories = new Set([...state.categories.expense, ...state.categories.income]);
             allCategories.forEach(cat => {
                const option = `<option value="${cat}">${cat}</option>`;
                categoryFilter.insertAdjacentHTML('beforeend', option);
             });
        }


        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Navigation
            getElements('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    
                    getElements('.page').forEach(page => page.classList.add('hidden'));
                    getElement(`#${targetId}`).classList.remove('hidden');

                    getElements('.nav-link').forEach(l => l.classList.remove('active', 'bg-indigo-100', 'dark:bg-gray-700'));
                    link.classList.add('active', 'bg-indigo-100', 'dark:bg-gray-700');
                });
            });

            // Theme toggle
            const themeToggle = getElement('#theme-toggle');
            const themeIcon = getElement('#theme-icon');
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                themeIcon.setAttribute('data-lucide', isDark ? 'moon' : 'sun');
                lucide.createIcons();
                renderAll(); // Re-render charts with new theme colors
            });

            // Modal controls
            getElement('#add-transaction-btn').addEventListener('click', () => openModal());
            getElement('#cancel-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            form.addEventListener('submit', handleFormSubmit);
            getElement('#type').addEventListener('change', (e) => updateCategoryOptions(e.target.value));

            // Filtering
            getElement('#apply-filters').addEventListener('click', applyFilters);
        }
        
        function addTableButtonListeners() {
            // Edit/Delete buttons
            getElements('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const transaction = state.transactions.find(t => t.id == id);
                    openModal(transaction);
                });
            });

            getElements('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (confirm('آیا از حذف این تراکنش مطمئن هستید؟')) {
                        state.transactions = state.transactions.filter(t => t.id != id);
                        renderAll();
                    }
                });
            });
        }

        function applyFilters() {
            const searchTerm = getElement('#search-input').value.toLowerCase();
            const typeFilter = getElement('#filter-type').value;
            const categoryFilter = getElement('#filter-category').value;
            const monthFilter = getElement('#filter-month').value;

            let filtered = state.transactions;

            if (searchTerm) {
                filtered = filtered.filter(t => t.description && t.description.toLowerCase().includes(searchTerm));
            }
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            if (monthFilter) {
                filtered = filtered.filter(t => dayjs(t.date).format('YYYY-MM') === monthFilter);
            }

            renderTransactionsPage(filtered);
            lucide.createIcons();
        }

        // --- INITIALIZATION ---
        function init() {
            // Set initial theme based on user preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                 document.documentElement.classList.add('dark');
                 getElement('#theme-icon').setAttribute('data-lucide', 'moon');
            }

            generateSampleData();
            setupEventListeners();
            renderAll();
            // Select dashboard by default
            getElement('a[href="#dashboard"]').click();
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
