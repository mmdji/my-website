<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد مدیریت مالی شخصی</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Day.js for date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/fa.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        /* For custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        /* Chart.js responsive fix */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .paid-row {
            opacity: 0.6;
            text-decoration: line-through;
        }
    </style>
    
    <script>
        // Initialize Day.js with Persian locale
        dayjs.locale('fa');
        dayjs.extend(dayjs_plugin_relativeTime);
        
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Vazirmatn', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="app" class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-white dark:bg-gray-800 shadow-lg md:shadow-none p-4 md:p-6 flex flex-row md:flex-col justify-between md:justify-start">
            <div>
                <div class="flex items-center gap-3 mb-8">
                    <div class="bg-indigo-500 p-2 rounded-lg">
                        <i data-lucide="wallet" class="text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">حساب من</h1>
                </div>
                <nav class="flex flex-row md:flex-col gap-2 justify-center">
                    <a href="#dashboard" class="nav-link active flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="layout-dashboard"></i><span>داشبورد</span>
                    </a>
                    <a href="#transactions" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="arrow-right-left"></i><span>تراکنش‌ها</span>
                    </a>
                    <a href="#reports" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                        <i data-lucide="bar-chart-3"></i><span>گزارش‌ها</span>
                    </a>
                    <a href="#debts" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700">
                       <i data-lucide="hand-coins"></i> <span>بدهی و طلب</span>
                    </a>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                 <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i id="theme-icon" data-lucide="sun"></i>
                </button>
                <div class="flex items-center gap-3">
                    <img src="https://placehold.co/40x40/6366f1/ffffff?text=U" alt="User" class="rounded-full">
                    <div class="hidden md:block">
                        <p class="font-semibold">کاربر تست</p>
                        <p class="text-xs text-gray-500">user@example.com</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- Dashboard Page -->
            <section id="dashboard" class="page">
                <h2 class="text-2xl font-bold mb-6">داشبورد خلاصه</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Summary Cards -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full">
                            <i data-lucide="arrow-down-left" class="text-green-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">مجموع درآمد</p>
                            <p id="summary-income" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-red-100 dark:bg-red-900 p-3 rounded-full">
                            <i data-lucide="arrow-up-right" class="text-red-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">مجموع هزینه</p>
                            <p id="summary-expense" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full">
                            <i data-lucide="scale" class="text-blue-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">موجودی فعلی</p>
                            <p id="summary-balance" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full">
                            <i data-lucide="alert-triangle" class="text-yellow-500"></i>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">بدهی‌های پرداخت‌نشده</p>
                            <p id="summary-debt" class="text-xl font-bold">0 تومان</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Charts -->
                    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">روند ماهانه</h3>
                        <div class="chart-container" style="height:300px">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">هزینه‌ها بر اساس دسته‌بندی</h3>
                        <div class="chart-container" style="height:300px">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Recent Transactions & Reminders -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">آخرین تراکنش‌ها</h3>
                        <div id="recent-transactions" class="space-y-4"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-bold mb-4">یادآوری بدهی و طلب</h3>
                        <div id="debt-reminders" class="space-y-4"></div>
                    </div>
                </div>
            </section>

            <!-- Transactions Page -->
            <section id="transactions" class="page hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">لیست تراکنش‌ها</h2>
                    <button id="add-transaction-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                        <i data-lucide="plus"></i><span>تراکنش جدید</span>
                    </button>
                </div>
                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6 flex flex-col md:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="جستجو در توضیحات..." class="flex-grow bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                    <select id="filter-type" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                        <option value="all">همه نوع</option>
                        <option value="income">درآمد</option>
                        <option value="expense">هزینه</option>
                    </select>
                    <select id="filter-category" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                         <option value="all">همه دسته‌بندی‌ها</option>
                    </select>
                    <input type="month" id="filter-month" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                    <select id="sort-by" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                        <option value="date-desc">مرتب‌سازی: تاریخ (جدیدترین)</option>
                        <option value="date-asc">مرتب‌سازی: تاریخ (قدیمی‌ترین)</option>
                        <option value="amount-desc">مرتب‌سازی: مبلغ (بیشترین)</option>
                        <option value="amount-asc">مرتب‌سازی: مبلغ (کمترین)</option>
                    </select>
                    <button id="apply-filters" class="bg-gray-200 dark:bg-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">اعمال</button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="border-b dark:border-gray-700">
                            <tr>
                                <th class="p-4">نوع</th>
                                <th class="p-4">دسته‌بندی</th>
                                <th class="p-4">مبلغ</th>
                                <th class="p-4">تاریخ</th>
                                <th class="p-4 hidden md:table-cell">توضیحات</th>
                                <th class="p-4">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Reports Page -->
            <section id="reports" class="page hidden">
                 <h2 class="text-2xl font-bold mb-6">گزارش‌گیری و تحلیل</h2>
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                     <div class="flex flex-col md:flex-row gap-4 mb-6 items-center">
                        <label for="report-month">انتخاب ماه:</label>
                        <input type="month" id="report-month" class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2">
                        <button id="generate-report-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">تولید گزارش</button>
                        <button id="export-csv-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2 ml-auto">
                            <i data-lucide="download"></i> <span>دانلود CSV</span>
                        </button>
                     </div>
                     <div id="report-output" class="space-y-6">
                        <p class="text-center text-gray-500">برای مشاهده گزارش، یک ماه را انتخاب کرده و دکمه "تولید گزارش" را بزنید.</p>
                     </div>
                 </div>
            </section>
            
            <!-- Debts Page -->
            <section id="debts" class="page hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">مدیریت بدهی و طلب</h2>
                    <button id="add-debt-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                        <i data-lucide="plus"></i><span>ثبت مورد جدید</span>
                    </button>
                </div>
                 <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-right">
                        <thead class="border-b dark:border-gray-700">
                            <tr>
                                <th class="p-4">نوع</th>
                                <th class="p-4">شخص</th>
                                <th class="p-4">مبلغ</th>
                                <th class="p-4">تاریخ سررسید</th>
                                <th class="p-4">وضعیت</th>
                                <th class="p-4">عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="debts-table-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h3 id="modal-title" class="text-xl font-bold mb-6">افزودن تراکنش جدید</h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="type" class="block mb-2 text-sm font-medium">نوع</label>
                        <select id="type" name="type" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                            <option value="expense">هزینه</option>
                            <option value="income">درآمد</option>
                        </select>
                    </div>
                    <div>
                        <label for="category" class="block mb-2 text-sm font-medium">دسته‌بندی</label>
                        <select id="category" name="category" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="amount" class="block mb-2 text-sm font-medium">مبلغ (تومان)</label>
                        <input type="number" id="amount" name="amount" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" placeholder="مثلا: 50000">
                    </div>
                     <div>
                        <label for="date" class="block mb-2 text-sm font-medium">تاریخ</label>
                        <input type="date" id="date" name="date" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block mb-2 text-sm font-medium">توضیحات (اختیاری)</label>
                        <textarea id="description" name="description" rows="3" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" placeholder="مثلا: خرید نان و شیر"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">انصراف</button>
                    <button type="submit" class="save-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ذخیره</button>
                </div>
            </form>
        </div>
    </div>

    <div id="debt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h3 id="debt-modal-title" class="text-xl font-bold mb-6">ثبت بدهی/طلب جدید</h3>
            <form id="debt-form">
                <input type="hidden" id="debt-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="debt-type" class="block mb-2 text-sm font-medium">نوع</label>
                        <select id="debt-type" name="type" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                            <option value="debt">بدهی (من باید پرداخت کنم)</option>
                            <option value="credit">طلب (من باید دریافت کنم)</option>
                        </select>
                    </div>
                    <div>
                        <label for="person" class="block mb-2 text-sm font-medium">شخص</label>
                        <input type="text" id="person" name="person" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" placeholder="مثلا: علی رضایی">
                    </div>
                    <div class="md:col-span-2">
                        <label for="debt-amount" class="block mb-2 text-sm font-medium">مبلغ (تومان)</label>
                        <input type="number" id="debt-amount" name="amount" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                    </div>
                     <div>
                        <label for="due-date" class="block mb-2 text-sm font-medium">تاریخ سررسید</label>
                        <input type="date" id="due-date" name="dueDate" required class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5">
                    </div>
                    <div class="md:col-span-2">
                        <label for="debt-description" class="block mb-2 text-sm font-medium">توضیحات (اختیاری)</label>
                        <textarea id="debt-description" name="description" rows="3" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">انصراف</button>
                    <button type="submit" class="save-btn px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ذخیره</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- DATA & STATE MANAGEMENT ---
        const STORAGE_KEY = 'personal-finance-data';
        const state = {
            transactions: [],
            categories: {
                expense: ['خوراک', 'حمل و نقل', 'مسکن', 'تفریح', 'پوشاک', 'سلامتی', 'بازپرداخت بدهی', 'سایر'],
                income: ['حقوق', 'پروژه', 'هدیه', 'سود سهام', 'وصول طلب', 'سایر']
            },
            currency: 'تومان',
            charts: {}
        };
        
        // --- DATA PERSISTENCE ---
        function saveDataToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.transactions));
        }

        function loadDataFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data && data !== '[]') {
                state.transactions = JSON.parse(data);
            } else {
                state.transactions = [];
                saveDataToStorage();
            }
        }

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('fa-IR').format(amount) + ` ${state.currency}`;
        const getElement = (selector) => document.querySelector(selector);
        const getElements = (selector) => document.querySelectorAll(selector);

        // --- UI & RENDERING FUNCTIONS ---
        function updateUI() {
            const currentHash = window.location.hash || '#dashboard';
            
            // Always update dashboard summary data as it affects all pages
            renderDashboard();

            // Render content for the currently active page
            switch(currentHash) {
                case '#transactions':
                    applyFilters();
                    break;
                case '#debts':
                    renderDebtsPage();
                    break;
            }
            populateCategoryFilter();
            lucide.createIcons();
        }
        
        function renderDashboard() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const unpaidDebt = state.transactions.filter(t => t.type === 'debt' && !t.paid).reduce((sum, t) => sum + t.amount, 0);
            
            getElement('#summary-income').textContent = formatCurrency(income);
            getElement('#summary-expense').textContent = formatCurrency(expense);
            getElement('#summary-balance').textContent = formatCurrency(income - expense);
            getElement('#summary-debt').textContent = formatCurrency(unpaidDebt);
            
            renderRecentTransactions();
            renderDebtReminders();
            renderCharts(income, expense);
        }

        function renderRecentTransactions() {
            const container = getElement('#recent-transactions');
            container.innerHTML = '';
            const incomeAndExpense = state.transactions.filter(t => t.type === 'income' || t.type === 'expense');

            const recent = [...incomeAndExpense]
                .sort((a, b) => dayjs(b.date).diff(dayjs(a.date)))
                .slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">تراکنشی برای نمایش وجود ندارد.</p>`;
                return;
            }

            recent.forEach(t => {
                const isIncome = t.type === 'income';
                const icon = isIncome ? 'trending-up' : 'trending-down';
                const color = isIncome ? 'green' : 'red';
                const sign = isIncome ? '+' : '-';

                const element = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-${color}-100 dark:bg-${color}-900 p-2 rounded-full">
                                <i data-lucide="${icon}" class="text-${color}-500 w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-semibold">${t.description || t.category}</p>
                                <p class="text-sm text-gray-500">${dayjs(t.date).format('dddd، D MMMM')}</p>
                            </div>
                        </div>
                        <p class="font-bold text-${color}-500">${sign}${formatCurrency(t.amount)}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', element);
            });
            lucide.createIcons();
        }
        
        function renderDebtReminders() {
            const container = getElement('#debt-reminders');
            container.innerHTML = '';
            const reminders = state.transactions
                .filter(t => (t.type === 'debt' || t.type === 'credit') && !t.paid)
                .sort((a, b) => dayjs(a.dueDate).diff(dayjs(b.dueDate)));
                
            if (reminders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">یادآوری فعالی وجود ندارد.</p>`;
                return;
            }

            reminders.slice(0, 4).forEach(t => {
                const isDebt = t.type === 'debt';
                const title = isDebt ? `بدهی به ${t.person}` : `طلب از ${t.person}`;
                const icon = 'alarm-clock';
                const color = dayjs(t.dueDate).isBefore(dayjs()) ? 'red' : 'yellow';
                
                const element = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="bg-${color}-100 dark:bg-${color}-900 p-2 rounded-full">
                                <i data-lucide="${icon}" class="text-${color}-500 w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="font-semibold">${title}</p>
                                <p class="text-sm text-${color}-500">سررسید: ${dayjs(t.dueDate).fromNow()}</p>
                            </div>
                        </div>
                        <p class="font-bold">${formatCurrency(t.amount)}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', element);
            });
            lucide.createIcons();
        }
        
        function renderTransactionsPage(transactionsToRender) {
            const tableBody = getElement('#transactions-table-body');
            tableBody.innerHTML = '';

            if (transactionsToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">هیچ تراکنشی یافت نشد.</td></tr>`;
                return;
            }

            transactionsToRender.forEach(t => {
                const isIncome = t.type === 'income';
                const typeText = isIncome ? 'درآمد' : 'هزینه';
                const typeColor = isIncome ? 'text-green-500' : 'text-red-500';
                const amountSign = isIncome ? '+' : '-';
                
                const row = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="p-4 font-semibold ${typeColor}">${typeText}</td>
                        <td class="p-4">${t.category}</td>
                        <td class="p-4 font-mono">${amountSign}${formatCurrency(t.amount)}</td>
                        <td class="p-4">${dayjs(t.date).format('YYYY/MM/DD')}</td>
                        <td class="p-4 hidden md:table-cell max-w-xs truncate">${t.description || '-'}</td>
                        <td class="p-4">
                            <div class="flex gap-2">
                                <button class="edit-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${t.id}">
                                    <i data-lucide="pencil" class="w-4 h-4 text-blue-500"></i>
                                </button>
                                <button class="delete-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${t.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            addTableButtonListeners('.edit-btn', '.delete-btn', openModal, handleDeleteTransaction);
            lucide.createIcons();
        }

        function renderDebtsPage() {
            const tableBody = getElement('#debts-table-body');
            tableBody.innerHTML = '';
            const debts = state.transactions
                .filter(t => t.type === 'debt' || t.type === 'credit')
                .sort((a,b) => (a.paid - b.paid) || dayjs(a.dueDate).diff(dayjs(b.dueDate)));
            
            if (debts.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">هیچ بدهی یا طلبی ثبت نشده است.</td></tr>`;
                return;
            }

            debts.forEach(d => {
                const isDebt = d.type === 'debt';
                const typeText = isDebt ? 'بدهی' : 'طلب';
                const typeColor = isDebt ? 'text-red-500' : 'text-green-500';
                const statusText = d.paid ? `تسویه شده در ${dayjs(d.paidDate).format('YYYY/MM/DD')}` : 'پرداخت نشده';
                const statusColor = d.paid ? 'text-gray-500' : 'text-yellow-500';
                const rowClass = d.paid ? 'paid-row' : '';

                const row = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 ${rowClass}">
                        <td class="p-4 font-semibold ${typeColor}">${typeText}</td>
                        <td class="p-4">${d.person}</td>
                        <td class="p-4 font-mono">${formatCurrency(d.amount)}</td>
                        <td class="p-4">${dayjs(d.dueDate).format('YYYY/MM/DD')} (${dayjs(d.dueDate).fromNow()})</td>
                        <td class="p-4 font-semibold ${statusColor}">${statusText}</td>
                        <td class="p-4">
                            <div class="flex gap-2">
                                ${!d.paid ? `<button class="settle-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${d.id}" title="تسویه حساب">
                                    <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                                </button>` : ''}
                                <button class="edit-debt-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${d.id}" title="ویرایش">
                                    <i data-lucide="pencil" class="w-4 h-4 text-blue-500"></i>
                                </button>
                                <button class="delete-debt-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full" data-id="${d.id}" title="حذف">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            addTableButtonListeners('.edit-debt-btn', '.delete-debt-btn', openDebtModal, handleDeleteTransaction);
            getElements('.settle-btn').forEach(btn => btn.addEventListener('click', (e) => handleSettle(e.currentTarget.dataset.id)));
            lucide.createIcons();
        }

        function renderCharts(income, expense) {
            // Expense Category Pie Chart
            const expenseCtx = getElement('#expenseCategoryChart').getContext('2d');
            const expenseData = state.transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            if (state.charts.expenseChart) state.charts.expenseChart.destroy();
            state.charts.expenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expenseData),
                    datasets: [{
                        data: Object.values(expenseData),
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#6366f1', '#a855f7'],
                        borderColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151' } } }
                }
            });

            // Monthly Trend Line Chart
            const monthlyCtx = getElement('#monthlyTrendChart').getContext('2d');
            const monthlyData = state.transactions
                .filter(t => t.type === 'income' || t.type === 'expense')
                .reduce((acc, t) => {
                const month = dayjs(t.date).format('YYYY-MM');
                if (!acc[month]) acc[month] = { income: 0, expense: 0 };
                if(t.type === 'income' || t.type === 'expense') {
                  acc[month][t.type] += t.amount;
                }
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort();
            
            if (state.charts.monthlyChart) state.charts.monthlyChart.destroy();
            state.charts.monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => dayjs(m).format('MMMM')),
                    datasets: [
                        { label: 'درآمد', data: sortedMonths.map(m => monthlyData[m].income), backgroundColor: 'rgba(34, 197, 94, 0.6)' },
                        { label: 'هزینه', data: sortedMonths.map(m => monthlyData[m].expense), backgroundColor: 'rgba(239, 68, 68, 0.6)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' } },
                        x: { ticks: { color: document.body.classList.contains('dark') ? '#9ca3af' : '#6b7280' } }
                    },
                     plugins: { legend: { labels: { color: document.body.classList.contains('dark') ? '#e5e7eb' : '#374151' } } }
                }
            });
        }

        // --- MODAL & FORM HANDLING ---
        const transactionModal = getElement('#transaction-modal');
        const transactionForm = getElement('#transaction-form');
        const debtModal = getElement('#debt-modal');
        const debtForm = getElement('#debt-form');

        function openModal(transaction = null) {
            transactionForm.reset();
            getElement('#transaction-id').value = '';
            
            if (transaction) {
                getElement('#modal-title').textContent = 'ویرایش تراکنش';
                getElement('#transaction-id').value = transaction.id;
                getElement('#type').value = transaction.type;
                updateCategoryOptions(transaction.type);
                getElement('#category').value = transaction.category;
                getElement('#amount').value = transaction.amount;
                getElement('#date').value = transaction.date;
                getElement('#description').value = transaction.description;
            } else {
                getElement('#modal-title').textContent = 'افزودن تراکنش جدید';
                getElement('#date').value = dayjs().format('YYYY-MM-DD');
                updateCategoryOptions('expense');
            }
            transactionModal.classList.remove('hidden');
        }

        function openDebtModal(debt = null) {
            debtForm.reset();
            getElement('#debt-id').value = '';

            if(debt) {
                getElement('#debt-modal-title').textContent = 'ویرایش بدهی/طلب';
                getElement('#debt-id').value = debt.id;
                getElement('#debt-type').value = debt.type;
                getElement('#person').value = debt.person;
                getElement('#debt-amount').value = debt.amount;
                getElement('#due-date').value = debt.dueDate;
                getElement('#debt-description').value = debt.description;
            } else {
                getElement('#debt-modal-title').textContent = 'ثبت بدهی/طلب جدید';
                getElement('#due-date').value = dayjs().format('YYYY-MM-DD');
            }
            debtModal.classList.remove('hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
        }

        function handleTransactionFormSubmit(e) {
            e.preventDefault();
            const id = getElement('#transaction-id').value;
            const formData = new FormData(transactionForm);
            const data = {
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseFloat(formData.get('amount')),
                date: formData.get('date'),
                description: formData.get('description'),
            };

            if (id) {
                const index = state.transactions.findIndex(t => t.id == id);
                state.transactions[index] = { ...state.transactions[index], ...data };
            } else {
                data.id = Date.now();
                state.transactions.push(data);
            }

            saveDataToStorage();
            closeModal(transactionModal);
            updateUI();
        }

        function handleDebtFormSubmit(e) {
            e.preventDefault();
            const id = getElement('#debt-id').value;
            const formData = new FormData(debtForm);
            const personName = formData.get('person');
            const data = {
                type: formData.get('type'),
                person: personName,
                amount: parseFloat(formData.get('amount')),
                dueDate: formData.get('dueDate'),
                description: formData.get('description') || (formData.get('type') === 'debt' ? `بدهی به ${personName}`: `طلب از ${personName}`),
                paid: false,
                paidDate: null,
            };

            if (id) {
                const index = state.transactions.findIndex(t => t.id == id);
                state.transactions[index] = { ...state.transactions[index], ...data };
            } else {
                data.id = Date.now();
                state.transactions.push(data);
            }
            
            saveDataToStorage();
            closeModal(debtModal);
            updateUI();
        }
        
        function updateCategoryOptions(type) {
            const categorySelect = getElement('#category');
            categorySelect.innerHTML = '';
            state.categories[type].forEach(cat => {
                const option = `<option value="${cat}">${cat}</option>`;
                categorySelect.insertAdjacentHTML('beforeend', option);
            });
        }
        
        function populateCategoryFilter() {
             const categoryFilter = getElement('#filter-category');
             categoryFilter.innerHTML = '<option value="all">همه دسته‌بندی‌ها</option>';
             const allCategories = new Set(state.transactions.map(t => t.category).filter(Boolean));
             allCategories.forEach(cat => {
                const option = `<option value="${cat}">${cat}</option>`;
                categoryFilter.insertAdjacentHTML('beforeend', option);
             });
        }
        
        // --- EVENT LISTENERS & NAVIGATION ---
        function navigateTo(hash) {
            // Update the URL hash
            window.location.hash = hash;

            // Show/Hide the correct page section
            getElements('.page').forEach(page => page.classList.add('hidden'));
            getElement(hash).classList.remove('hidden');

            // Update active link styles
            getElements('.nav-link').forEach(l => l.classList.remove('active', 'bg-indigo-100', 'dark:bg-gray-700'));
            getElement(`a[href="${hash}"]`).classList.add('active', 'bg-indigo-100', 'dark:bg-gray-700');

            // Render the content for the new page
            switch(hash) {
                case '#dashboard':
                    renderDashboard();
                    break;
                case '#transactions':
                    applyFilters();
                    break;
                case '#reports':
                    getElement('#report-output').innerHTML = '<p class="text-center text-gray-500">برای مشاهده گزارش، یک ماه را انتخاب کرده و دکمه "تولید گزارش" را بزنید.</p>';
                    break;
                case '#debts':
                    renderDebtsPage();
                    break;
            }
            lucide.createIcons(); // Refresh icons after rendering
        }

        function setupEventListeners() {
            // Navigation
            getElements('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href');
                    navigateTo(targetId);
                });
            });

            // Theme toggle
            const themeToggle = getElement('#theme-toggle');
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                getElement('#theme-icon').setAttribute('data-lucide', isDark ? 'moon' : 'sun');
                lucide.createIcons();
                updateUI(); // Re-render charts with new theme colors
            });

            // Modal controls
            getElement('#add-transaction-btn').addEventListener('click', () => openModal());
            getElement('#add-debt-btn').addEventListener('click', () => openDebtModal());
            transactionForm.addEventListener('submit', handleTransactionFormSubmit);
            debtForm.addEventListener('submit', handleDebtFormSubmit);
            getElement('#type').addEventListener('change', (e) => updateCategoryOptions(e.target.value));

            getElements('.cancel-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.fixed');
                closeModal(modal);
            }));
            
            // Filtering and Sorting
            getElement('#apply-filters').addEventListener('click', applyFilters);
            getElement('#sort-by').addEventListener('change', applyFilters);

            // Reports
            getElement('#generate-report-btn').addEventListener('click', generateReport);
            getElement('#export-csv-btn').addEventListener('click', exportToCSV);
        }

        function addTableButtonListeners(editSelector, deleteSelector, editFn, deleteFn) {
            getElements(editSelector).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const transaction = state.transactions.find(t => t.id == id);
                    editFn(transaction);
                });
            });

            getElements(deleteSelector).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    deleteFn(id);
                });
            });
        }

        function handleDeleteTransaction(id) {
             if (confirm('آیا از حذف این مورد مطمئن هستید؟')) {
                state.transactions = state.transactions.filter(t => t.id != id);
                saveDataToStorage();
                updateUI();
            }
        }

        function handleSettle(id) {
            const debtItem = state.transactions.find(t => t.id == id);
            if(!debtItem || debtItem.paid) return;

            if (confirm(`آیا از تسویه حساب به مبلغ ${formatCurrency(debtItem.amount)} مطمئن هستید؟ این عمل یک تراکنش جدید ثبت خواهد کرد.`)) {
                debtItem.paid = true;
                debtItem.paidDate = dayjs().format('YYYY-MM-DD');

                const newTransaction = {
                    id: Date.now(),
                    amount: debtItem.amount,
                    date: debtItem.paidDate,
                };

                if (debtItem.type === 'debt') { // I paid my debt
                    newTransaction.type = 'expense';
                    newTransaction.category = 'بازپرداخت بدهی';
                    newTransaction.description = `پرداخت بدهی به ${debtItem.person}`;
                } else { // I received my credit
                    newTransaction.type = 'income';
                    newTransaction.category = 'وصول طلب';
                    newTransaction.description = `دریافت طلب از ${debtItem.person}`;
                }
                
                state.transactions.push(newTransaction);
                saveDataToStorage();
                updateUI();
            }
        }

        function applyFilters() {
            const searchTerm = getElement('#search-input').value.toLowerCase();
            const typeFilter = getElement('#filter-type').value;
            const categoryFilter = getElement('#filter-category').value;
            const monthFilter = getElement('#filter-month').value;
            const sortBy = getElement('#sort-by').value;

            let filtered = state.transactions.filter(t => t.type === 'income' || t.type === 'expense');

            if (searchTerm) {
                filtered = filtered.filter(t => t.description && t.description.toLowerCase().includes(searchTerm));
            }
            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            if (monthFilter) {
                filtered = filtered.filter(t => dayjs(t.date).format('YYYY-MM') === monthFilter);
            }

            // Sort the filtered results
            switch (sortBy) {
                case 'date-asc':
                    filtered.sort((a, b) => dayjs(a.date).diff(dayjs(b.date)));
                    break;
                case 'amount-desc':
                    filtered.sort((a, b) => b.amount - a.amount);
                    break;
                case 'amount-asc':
                    filtered.sort((a, b) => a.amount - b.amount);
                    break;
                case 'date-desc':
                default:
                    filtered.sort((a, b) => dayjs(b.date).diff(dayjs(a.date)));
                    break;
            }

            renderTransactionsPage(filtered);
        }

        function generateReport() {
            const month = getElement('#report-month').value;
            const output = getElement('#report-output');
            if(!month) {
                output.innerHTML = '<p class="text-center text-red-500">لطفا یک ماه را برای گزارش‌گیری انتخاب کنید.</p>';
                return;
            }

            const monthTransactions = state.transactions.filter(t => (t.type === 'income' || t.type === 'expense') && dayjs(t.date).format('YYYY-MM') === month);
            
            if(monthTransactions.length === 0) {
                output.innerHTML = `<p class="text-center text-gray-500">هیچ تراکنشی برای ماه ${dayjs(month).format("MMMM YYYY")} یافت نشد.</p>`;
                return;
            }

            const income = monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const expenseByCategory = monthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            let reportHTML = `
                <h3 class="text-xl font-bold">گزارش ماه ${dayjs(month).format("MMMM YYYY")}</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-green-100 dark:bg-green-900 rounded-lg"><p>مجموع درآمد</p><p class="font-bold text-lg">${formatCurrency(income)}</p></div>
                    <div class="p-4 bg-red-100 dark:bg-red-900 rounded-lg"><p>مجموع هزینه</p><p class="font-bold text-lg">${formatCurrency(expense)}</p></div>
                    <div class="p-4 bg-blue-100 dark:bg-blue-900 rounded-lg"><p>مانده</p><p class="font-bold text-lg">${formatCurrency(income-expense)}</p></div>
                </div>
                <div>
                    <h4 class="font-bold mt-6 mb-2">ریز هزینه‌ها بر اساس دسته‌بندی</h4>
                    <ul class="space-y-2">
            `;
            
            Object.entries(expenseByCategory).sort(([,a],[,b]) => b-a).forEach(([category, amount]) => {
                reportHTML += `<li class="flex justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><span>${category}</span><span class="font-mono">${formatCurrency(amount)}</span></li>`;
            });

            reportHTML += `</ul></div>`;
            output.innerHTML = reportHTML;
        }

        function exportToCSV() {
            const month = getElement('#report-month').value;
            if(!month) {
                alert('لطفا ابتدا یک ماه را انتخاب کرده و گزارش را تولید کنید.');
                return;
            }

            const monthTransactions = state.transactions.filter(t => (t.type === 'income' || t.type === 'expense') && dayjs(t.date).format('YYYY-MM') === month);
            if(monthTransactions.length === 0) {
                alert('تراکنشی برای این ماه جهت خروجی گرفتن وجود ندارد.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "نوع,دسته‌بندی,مبلغ,تاریخ,توضیحات\n";

            monthTransactions.forEach(t => {
                const row = [t.type, t.category, t.amount, t.date, `"${t.description || ''}"`].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report-${month}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }

        // --- INITIALIZATION ---
        function init() {
            // Set initial theme
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                 document.documentElement.classList.add('dark');
                 getElement('#theme-icon').setAttribute('data-lucide', 'moon');
            }

            loadDataFromStorage();
            setupEventListeners();

            // Handle page load and navigate to the correct hash
            const currentHash = window.location.hash || '#dashboard';
            navigateTo(currentHash);
        }

        // Run the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

